
# Документация проекта «ShortLinks»

## 1. Общее описание

**ShortLinks** — это сервис сокращения ссылок, реализованный на Java без использования Maven. Сервис предоставляет следующие функции:

- **Генерация коротких URL**  
    Длинный URL сокращается до вида:  
    `denzo.com/<код>`  
    где `<код>` — сгенерированная случайная строка фиксированной длины (например, 6 символов).
    
- **Редактирование лимита переходов**  
    Создатель ссылки может изменить лимит переходов по ссылке.
    
- **Удаление ссылки**  
    Только создатель ссылки имеет возможность удалить её.
    
- **Администрирование параметров ссылки**  
    Изменения (редактирование лимита или удаление) доступны только владельцу ссылки.
    
- **Повторное создание ссылок**  
    Повторное сокращение одной и той же длинной ссылки генерирует новый короткий URL.
    
- **Смена пользователя**  
    Пользователь может сменить текущий аккаунт (UUID), после чего все операции производятся от имени нового пользователя.
    

---

## 2. Структура проекта

Структура проекта выглядит следующим образом:

```
denzomaster@192:~/IdeaProjects/ShortLinks$ tree
.
├── out
│   └── production
│       └── ShortLinks
│           └── com
│               └── denzo
│                   ├── App.class
│                   ├── ConsoleNotifier.class
│                   ├── Notifier.class
│                   ├── ShortLink.class
│                   ├── UrlShorter.class
│                   ├── UrlShorterManualTest.class
│                   └── User.class
├── ShortLinks.iml
└── src
    └── com
        └── denzo
            ├── App.java
            ├── ConsoleNotifier.java
            ├── Notifier.java
            ├── ShortLink.java
            ├── UrlShorter.java
            ├── UrlShorterManualTest.java
            └── User.java

9 directories, 15 files

```

> **Примечание:**  
> Файлы с исходным кодом находятся в каталоге `src/com/denzo`.  
> Для сборки и запуска используется встроенная система сборки IntelliJ IDEA

---

## 3. Описание классов

### 3.1. **App.java**

**Назначение:**  
Класс `App` содержит главный метод `main()`, который реализует консольное меню для работы с сервисом. Пользователь может:

- Создавать короткие ссылки;
- Просматривать все свои ссылки и статистику (лимит переходов, текущее количество переходов, срок действия);
- Переходить по коротким ссылкам (открытие URL в браузере);
- Удалять ссылку (только владельцем);
- Сменить пользователя.

**Ключевые методы:**

- `initializeUser()` и `chooseUser()`: инициализация или смена текущего пользователя (работа с UUID).
- `showMenu()`: вывод меню.
- `createShortLink()`: создание новой короткой ссылки.
- `listShortLinks()`: вывод списка ссылок текущего пользователя.
- `useShortLink()`: переход по указанной короткой ссылке (с проверками и открытием в браузере).
- `deleteLink()`: удаление указанной ссылки (доступно только владельцу).
- `switchUser()`: смена текущего пользователя.

---

### 3.2. **Notifier.java**

**Назначение:**  
Интерфейс, определяющий метод уведомления пользователя.

**Метод:**

- `void notify(UUID userUuid, String message)`: метод для отправки уведомления (например, вывод в консоль или отправка e-mail).

---

### 3.3. **ConsoleNotifier.java**

**Назначение:**  
Реализация интерфейса `Notifier`, в которой уведомления выводятся в консоль.

**Метод:**

- `notify(UUID userUuid, String message)`: выводит уведомление в формате  
    `Уведомление пользователю <UUID>: <сообщение>`.

---

### 3.4. **ShortLink.java**

**Назначение:**  
Класс-модель для хранения информации о ссылке.

**Поля:**

- `longUrl`: исходный длинный URL.
- `shortUrl`: сгенерированный короткий код (без доменного префикса).
- `limit`: максимальное количество переходов по ссылке.
- `creationTime`: время создания ссылки.
- `expireAt`: время, когда ссылка истекает.
- `currentCount`: текущее количество переходов.
- `ownerUuid`: UUID пользователя, создавшего ссылку.

**Методы:**

- Геттеры и сеттеры для полей.
- `incrementCount()`: увеличение счетчика переходов.
- `isExpired()`: проверка, истекло ли время жизни ссылки.
- `isLimitExceeded()`: проверка, достигнут ли лимит переходов.
- `toString()`: строковое представление объекта.

---

### 3.5. **UrlShorter.java**

**Назначение:**  
Основной класс, реализующий бизнес-логику сервиса сокращения ссылок. Отвечает за:

- Генерацию коротких ссылок с префиксом `denzo.com/` (с использованием метода `buildShortUrl()`).
- Восстановление длинного URL по короткой ссылке (метод `restoreLongUrl()`, с проверками: истек ли срок, превышен ли лимит).
- Редактирование лимита переходов (`editLimit()`) — только создатель может изменять параметры.
- Удаление ссылки (`deleteLink()`) — доступно только владельцу.
- Очистку просроченных ссылок (`cleanupExpiredLinks()`).
- Получение ссылки по её короткому коду и списка ссылок пользователя.

**Ключевые методы:**

- `buildShortUrl(String longUrl, UUID userUuid, int limit, int lifetimeHours)`
- `restoreLongUrl(String shortUrl)`
- `editLimit(String shortUrl, int newLimit, UUID requesterUuid)`
- `deleteLink(String shortUrl, UUID requesterUuid)`
- `cleanupExpiredLinks()`
- `getShortLinkByShortUrl(String shortUrl)`
- `getShortLinksByUserUuid(UUID userUuid)`
- Вспомогательные методы: `normalizeShortUrl(String shortUrl)` и `generateRandomShortUrl()`

---

### 3.6. **User.java**

**Назначение:**  
Класс `User` представляет пользователя сервиса. Генерирует и хранит уникальный идентификатор (UUID).

**Методы:**

- Конструктор, генерирующий новый UUID.
- `getUuid()`, `setUuid(UUID uuid)` – геттер и сеттер.
- `toString()` – строковое представление пользователя.

---

### 3.7. **UrlShorterManualTest.java**

**Назначение:**  
Класс для ручного тестирования всех функций сервиса. Тесты выполняются через метод `main()`, который последовательно запускает тесты:

- **testBuildShortUrl()**: Проверяет, что при создании ссылка начинается с `denzo.com/`.
- **testEditLimit()**: Проверяет изменение лимита переходов и его влияние.
- **testDeleteLink()**: Проверяет удаление ссылки владельцем.
- **testAdminAccess()**: Проверяет, что изменение и удаление недоступны для не владельца.
- **testRepeatCreation()**: Проверяет, что повторное сокращение одинакового URL генерирует новый код.
- **testSwitchUser()**: Проверяет, что ссылки создаются от имени разных пользователей.


---

## 4. Инструкция по запуску и использованию

### 4.1 Сборка и запуск проекта в IntelliJ IDEA

1. **Открытие проекта:**  
    Откройте проект «ShortLinks» в IntelliJ IDEA.
    
2. **Проверка структуры:**  
    Убедитесь, что все исходные файлы находятся в пакете `com.denzo` в каталоге `src/com/denzo`.
    
3. **Запуск основного приложения:**  
    Запустите класс `App.java` (щёлкните правой кнопкой мыши → **Run 'App.main()'**).  
    В консоли будет отображаться меню, позволяющее работать с функционалом сервиса: создание ссылок, просмотр, переход, удаление, смена пользователя.
    
4. **Запуск тестов:**  
    Для ручного тестирования запустите класс `UrlShorterManualTest.java` (щёлкните правой кнопкой мыши → **Run 'UrlShorterManualTest.main()'**).  
    Результаты каждого теста будут выведены в консол
    

# Алгоритм сокращения, хранения и перехода ссылок

## 1. Сокращение ссылки

### 1.1. Генерация короткого кода

При сокращении длинного URL выполняются следующие шаги:

1. **Входные данные:**  
   - Длинный URL (например, `https://www.baeldung.com/java-9-http-client`).
   - UUID пользователя, создающего ссылку.
   - Лимит переходов (максимальное число кликов).
   - Время жизни ссылки (в часах).

2. **Генерация короткого кода:**  
   - Используется метод `generateRandomShortUrl()`.
   - Алгоритм генерирует случайную строку фиксированной длины (например, 6 символов) из заданного алфавита:
     ```
     "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
     ```
   - Если сгенерированный код уже существует в хранилище, происходит повторная генерация до получения уникального значения.

3. **Формирование полного короткого URL:**  
   - К короткому коду добавляется доменный префикс `denzo.com/`.
   - Результатом является строка вида:  
     `denzo.com/3DZHeG`.

### 1.2. Повторное создание ссылки

- При повторном запросе на сокращение одной и той же длинной ссылки (даже от одного и того же пользователя) генерируется новый уникальный код, так как алгоритм всегда выполняет случайную генерацию.

---

## 2. Хранение ссылок

### 2.1. Структуры хранения

В реализации используются две основные структуры данных:

1. **Карта коротких ссылок (shortUrlMap):**  
   - Представляет собой `Map<String, ShortLink>`, где ключ – это сгенерированный код короткой ссылки (без доменного префикса), а значение – объект `ShortLink`.
   - Позволяет быстро находить ссылку по её коду.

2. **Карта ссылок по пользователям (userLinksMap):**  
   - Представляет собой `Map<UUID, List<ShortLink>>`, где ключ – UUID пользователя, а значение – список сокращённых ссылок, созданных этим пользователем.
   - Позволяет получить все ссылки конкретного пользователя для отображения статистики.

### 2.2. Объект ShortLink

Объект `ShortLink` хранит следующие данные:
- **longUrl:** Исходный длинный URL.
- **shortUrl:** Сгенерированный короткий код (без префикса).
- **limit:** Максимальное количество переходов по ссылке.
- **creationTime:** Время создания ссылки.
- **expireAt:** Время истечения жизни ссылки (рассчитывается как `creationTime + lifetimeHours`).
- **currentCount:** Счетчик уже совершенных переходов.
- **ownerUuid:** UUID пользователя, создавшего ссылку.

При создании ссылки объект `ShortLink` сохраняется в обе карты (`shortUrlMap` и `userLinksMap`) для дальнейшего доступа.

---

## 3. Переход по короткой ссылке

### 3.1. Обработка запроса на переход

При переходе по короткой ссылке (метод `restoreLongUrl(shortUrl)`) выполняются следующие шаги:

1. **Нормализация ссылки:**  
   - Если пользователь вводит короткий URL с доменным префиксом (например, `denzo.com/3DZHeG`), метод `normalizeShortUrl()` удаляет префикс, оставляя только код ссылки (например, `3DZHeG`).

2. **Поиск ссылки в хранилище:**  
   - С помощью карты `shortUrlMap` выполняется поиск объекта `ShortLink` по коду.

3. **Проверки:**  
   - Если ссылка не найдена, возвращается `null` и выводится сообщение, что ссылка не существует.
   - Если время жизни ссылки истекло (проверка с помощью `isExpired()`), ссылка удаляется из обеих карт, отправляется уведомление владельцу, и метод возвращает `null`.
   - Если количество переходов достигло лимита (проверка с помощью `isLimitExceeded()`), отправляется уведомление владельцу, и метод возвращает `null`.

4. **Успешное восстановление:**  
   - Если все проверки пройдены, значение счетчика переходов увеличивается (`incrementCount()`).
   - Возвращается исходный длинный URL.

### 3.2. Открытие ссылки в браузере

В классе **App** при выборе опции «Перейти по короткой ссылке» происходит вызов метода `useShortLink()`, который:
- Запрашивает у пользователя короткий URL.
- Восстанавливает длинный URL через `UrlShorter.restoreLongUrl()`.
- При успешном восстановлении открывает URL в браузере, используя класс `Desktop`

---

## 4. Администрирование параметров ссылки

### 4.1. Редактирование лимита переходов

Метод `editLimit(shortUrl, newLimit, requesterUuid)`:
- Принимает короткий URL, новый лимит и UUID пользователя, который запрашивает изменение.
- Проверяет, что ссылка существует и что UUID запрашивающего совпадает с владельцем ссылки.
- Если проверки пройдены, обновляет лимит переходов.

### 4.2. Удаление ссылки

Метод `deleteLink(shortUrl, requesterUuid)`:
- Принимает короткий URL и UUID пользователя.
- Проверяет, что ссылка существует и что запрос исходит от владельца.
- Если проверки успешны, ссылка удаляется из карт `shortUrlMap` и `userLinksMap`.

---

## 5. Смена пользователя

В классе **App** реализована функция смены пользователя:
- Функция позволяет пользователю ввести существующий UUID или сгенерировать новый.
- После смены пользователя все операции выполняются от имени нового пользователя (создание, просмотр, редактирование и удаление ссылок).

---

## 6. Тестирование функционала (UrlShorterManualTest.java)

Класс `UrlShorterManualTest` содержит методы для ручного тестирования основных функций:
- **testBuildShortUrl()**: Проверяет, что ссылка создается с префиксом `denzo.com/` и уникальна для разных пользователей.
- **testEditLimit()**: Проверяет возможность изменения лимита переходов владельцем и корректность блокировки переходов при превышении лимита.
- **testDeleteLink()**: Проверяет успешное удаление ссылки владельцем и недоступность ссылки после удаления.
- **testAdminAccess()**: Проверяет, что изменение или удаление ссылки не доступно пользователю, не являющемуся владельцем.
- **testRepeatCreation()**: Проверяет, что повторное сокращение одинакового длинного URL генерирует новый короткий URL.
- **testSwitchUser()**: Проверяет, что ссылки, созданные разными пользователями, принадлежат им независимо друг от друга.

Запуск тестов осуществляется через вызов метода `main()` в классе `UrlShorterManualTest`.

---
